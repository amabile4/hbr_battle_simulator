# ヘブンバーンズレッド 戦闘行動シミュレータ 要求仕様書 v1.6

## 作成日時
2025年05月26日 01時15分42秒 (JST)

## 更新履歴
- v1.0 (20250525152142): 初版作成、基本戦闘システム・Google Spreadsheet形式分析
- v1.1 (20250525242156): 内部データ管理設計（Pythonクラス構造）追加
- v1.2 (20250525243048): ターン管理システム詳細仕様追加
- v1.3 (20250526004215): プレイヤー配置管理システム詳細仕様追加
- v1.4 (20250526004832): 文書分割・コードサンプル外部化
- v1.5 (20250526010518): 戦闘行動シミュレータに特化した要求仕様に再構成
- v1.6 (20250526011542): スキル分類・SP管理システム詳細仕様追加

## ファイル構成
- **メイン仕様書**: 20250526011542.md（本ファイル）
- **将来機能仕様**: 20250526010518-future_features.md
- **コードサンプル**: 20250526004832-code_sample.py
- **データ構造定義**: 20250526004832-data_structures.py

## 1. シミュレータ概要

### 1.1 目的
ヘブンバーンズレッドの戦闘における**プレイヤーの行動選択と記録**、特に**SP管理の自動記録・計算・閲覧**を主目的とした戦闘行動シミュレータの作成

### 1.2 対象範囲
- **対象**: プレイヤーの行動選択・記録・履歴管理・SP管理
- **非対象**: ダメージ計算、敵AI、戦闘結果計算

### 1.3 最終出力
Google Spreadsheet互換のCSV形式での戦闘行動記録

## 2. 基本戦闘システム（シミュレータ対象範囲）

### 2.1 パーティー構成
- **基本構成**: 6人パーティー（前衛3人 + 後衛3人）
- **行動可能**: 前衛のみがスキル使用・攻撃を受ける
- **前後衛交代**: 戦闘中に前衛と後衛を入れ替え可能

### 2.2 ターン進行
- **ターン開始**: プレイヤーによる配置調整
- **行動選択**: 前衛キャラクターのスキル選択
- **ターン終了**: 行動記録の保存

## 3. スキル分類システム

### 3.1 スキルの基本分類

#### 3.1.1 特性
- **発動条件**: 所持しているだけで自動的に発動
- **装着選択**: 不可（自身の意思で装着を選択できない）
- **効果範囲**: 自身または他キャラクターへの影響
- **シミュレータ対応**: 初期設定として反映

#### 3.1.2 パッシブスキル
- **発動条件**: 所持しているだけで自動的に発動
- **装着選択**: 可能（自身の意思で装着するかしないか選択可能）
- **効果範囲**: 自身または他キャラクターへの影響
- **シミュレータ対応**: 装着設定として管理

#### 3.1.3 アクティブスキル
- **発動条件**: ターンでの行動時にスキルを選択して実行
- **装着選択**: 使用時に選択
- **効果範囲**: 攻撃、回復、バフ・デバフ等
- **シミュレータ対応**: メインの記録対象

### 3.2 アクティブスキル分類（行動順序決定用）

#### 3.2.1 非ダメージスキル
- **回復スキル**: HP・DP回復
- **バフ・デバフスキル**: 能力値変更
- **補助スキル**: SP回復、状態異常解除等
- **位置移動スキル**: 強制的な配置変更

#### 3.2.2 ダメージスキル
- **攻撃スキル**: 純粋な攻撃
- **ダメージ付きデバフスキル**: 攻撃＋デバフ効果

## 4. SP管理システム（詳細仕様）

### 4.1 基本概念
- **SP**: スキルポイント（各キャラクターが持つリソース）
- **上限**: 通常は20、オーバードライブ時は上限を超えて回復可能
- **消費**: アクティブスキル使用時に消費
- **回復**: 様々な条件で自動回復

### 4.2 初期SP設定

#### 4.2.1 基本初期SP
- **バトル開始時**: 基本値4

#### 4.2.2 装備による初期SP追加
- **装備効果**: +0～+3の追加
- **シミュレータ対応**: 各キャラクターの初期SP値として直接指定

#### 4.2.3 パッシブスキル・特性による初期SP追加
- **自身への効果**: +0～+5の追加
- **他者への効果**: 他キャラクターの初期SPを+0～+5
- **条件付き効果**: 「バトル開始時に前衛にいた場合」等
- **シミュレータ対応**: 各キャラクターの初期SP値として直接指定

### 4.3 ターン経過によるSP回復

#### 4.3.1 基本回復
- **通常ターン経過時**: SP+2

#### 4.3.2 パッシブスキル・特性による追加回復（自身）
- **ターン開始時に前衛**: SP+1
- **ターン開始時に後衛**: SP+1
- **バトル内で初めて追加ターン**: SP+5
- **その他**: スキルによる様々な条件

#### 4.3.3 パッシブスキル・特性による追加回復（他者）
- **例**: 「ターン開始時に自身が前衛にいた場合、後衛のSP+1」
- **範囲**: 他の特定キャラクター、前衛、後衛、パーティー全体等

### 4.4 アクティブスキルによるSP回復

#### 4.4.1 単体対象スキル
- **例**: 「選択した1キャラクターのSPを+6する」

#### 4.4.2 範囲対象スキル
- **前衛対象**: 「前衛のSPを+3する」
- **前衛（自分除く）**: 「自らを除く前衛のSPを+3する」
- **パーティー全体**: 「パーティー全体のSPを+5する」

### 4.5 オーバードライブによるSP回復

#### 4.5.1 ゲージレベル別回復量
- **OD1**: SP+5, 追加ターン+1
- **OD2**: SP+12, 追加ターン+2
- **OD3**: SP+20, 追加ターン+3

#### 4.5.2 発動対象
- **発動者**: オーバードライブを発動したキャラクター
- **上限突破**: 通常上限20を超えて回復可能

### 4.6 SP管理の記録対象

#### 4.6.1 基本記録項目
- **ターン開始前SP値**: 各ターン開始時の6人全員のSP値
- **ターン終了後SP値**: 各ターン終了時の6人全員のSP値
- **SP変動**: 開始時と終了時の差分

#### 4.6.2 詳細記録項目（将来対応）
- **回復要因**: 自動回復、スキル回復、オーバードライブ等
- **消費要因**: 使用したアクティブスキル
- **回復量内訳**: 基本+2、パッシブ効果、アクティブ効果等

## 5. ターン管理システム

### 5.1 基本ターン概念
- **開始**: ターン0から開始
- **進行**: 1行動ごとに1ずつ増加
- **例外**: 特殊ターン状態ではターン数は増加しない

### 5.2 通常ターンシステム
- **ターン番号**: 0, 1, 2, 3, ... の連続番号
- **進行条件**: プレイヤーと敵の行動が完了したら次のターンへ
- **0ターン目**: 敵の先制攻撃がある場合のみ存在
- **SP回復**: 通常ターン経過時に基本SP+2

### 5.3 特殊ターンシステム

#### 5.3.1 オーバードライブ状態
- **オーバードライブゲージ**: -300% ～ +300% の範囲
- **発動条件**: ゲージが100%以上でオーバードライブ実行ボタンを押下
- **種類**: OD1, OD2, OD3の3段階
- **継続**: 各段階ごとに決められた回数のプレイヤー行動が可能
- **表記**: CSV出力では「OD1」「OD2」「OD3」として記録
- **SP効果**: 発動者のSPが段階に応じて回復

#### 5.3.2 追加ターン
- **発生条件**: 特定スキル実行後に付与される
- **種類**: 自分のみ、前衛全員など様々なパターン
- **継続**: 通常は1ターンのみ
- **表記**: CSV出力では「追加1」「追加2」として記録
- **SP効果**: 初回追加ターン時にSP+5（パッシブ効果）

## 6. プレイヤー配置管理システム

### 6.1 基本配置概念
- **配置ポジション**: 6つのポジション（1, 2, 3, 4, 5, 6）
- **表示順序**: 左から1, 2, 3, 4, 5, 6の順番
- **前衛**: ポジション1, 2, 3（スキル使用可能）
- **後衛**: ポジション4, 5, 6（待機状態）

### 6.2 配置交代システム
- **通常ターン**: 全プレイヤー（6人）の位置を自由に入れ替え可能
- **オーバードライブターン**: 通常ターンと同様（全員交代可能）
- **追加ターン**: 追加ターン状態のプレイヤーのみ交代可能

### 6.3 追加ターンでの交代制限
- **前衛全員が追加ターン**: 前衛3人（ポジション1,2,3）のみ交代可能
- **自分のみ追加ターン（1人）**: 交代不可（相手がいないため）
- **自分のみ追加ターン（2人）**: その2人の間でのみ交代可能
- **混合パターン**: 追加ターン状態のプレイヤー間でのみ交代可能

### 6.4 配置とSP回復の関係
- **前衛配置**: ターン開始時に前衛にいた場合のSP回復効果
- **後衛配置**: ターン開始時に後衛にいた場合のSP回復効果
- **配置依存パッシブ**: 配置による他者への影響

## 7. 行動順序決定システム

### 7.1 実行順序ルール
1. **第1フェーズ**: 非ダメージスキル使用者
   - ポジション順（1 → 2 → 3）で行動
2. **第2フェーズ**: ダメージスキル使用者
   - ポジション順（1 → 2 → 3）で行動

### 7.2 行動順序の例
```
ポジション1: ダメージスキル（通常攻撃）
ポジション2: 非ダメージスキル（SP回復）  
ポジション3: ダメージスキル（専用スキル）

実行順序: ポジション2 → ポジション1 → ポジション3
```

## 8. バフ・デバフ管理システム

### 8.1 管理対象
- **プレイヤーパーティーのバフ状態**: 攻撃力アップ、防御力アップなど
- **敵のデバフ状態**: 攻撃力ダウン、防御力ダウンなど

### 8.2 エンハンス（攻撃力アップバフ）
- **重複**: 2回まで重ね掛け可能
- **重要性**: ダメージに大幅な影響（記録目的）

### 8.3 記録方法
- **現状**: CSV出力の1行目タイトル行に簡易記録
- **将来**: 専用列での詳細管理予定

## 9. 記録・出力システム

### 9.1 記録対象データ
- **ターン情報**: ターン番号、特殊ターン状態
- **配置情報**: 6人の配置状況、配置変更履歴
- **行動情報**: 前衛3人のスキル選択
- **SP情報**: ターン開始前・終了後のSP値、SP変動要因
- **バフ・デバフ情報**: 現在の状態

### 9.2 出力フォーマット（Google Spreadsheet形式）

#### 9.2.1 基本構造
- **3行ヘッダ** + データ行形式
- **文字エンコーディング**: UTF-8
- **出力形式**: CSV（Google Spreadsheet互換）

#### 9.2.2 ヘッダ構造（1-3行目）
- **1行目**: タイトル・バフ情報など
- **2行目**: キャラクター名配置（E列から6人分、3列間隔）
- **3行目**: 列ヘッダ（ターン、敵行動など、始、行動、終...）

#### 9.2.3 列構造
- **A列**: 余白
- **B列**: ターン（通常: 1,2,3... 特殊: OD1,OD2,OD3,追加1等）
- **C列**: 敵行動など
- **D列**: 余白
- **E-V列**: 6キャラクター分のデータ（各3列ずつ：始SP、行動、終SP）

#### 9.2.4 SP記録の詳細
- **始SP**: ターン開始時のSP値（基本回復後の値）
- **終SP**: ターン終了時のSP値（スキル使用・回復後の値）
- **変動要因**: 将来的にはコメント等で詳細記録

## 10. 実装対象機能（v1.0）

### 10.1 ターン管理・記録システム
- 通常ターン進行システム
- 特殊ターン管理システム（OD1-3、追加ターン）
- ターンごとの行動記録機能
- 行動履歴の表形式表示機能

### 10.2 パーティー管理システム
- 6人パーティー管理（ポジション1-6）
- 前後衛配置システム（前衛1-3、後衛4-6）
- 配置交代システム（通常・特殊ターン対応）
- 追加ターン状態管理
- 交代可能性判定システム
- 配置記録の保存

### 10.3 スキル管理システム
- アクティブスキル選択機能（前衛キャラクター）
- スキル分類判定機能（ダメージ・非ダメージ）
- 行動順序決定ロジック（2フェーズ制）
- パッシブスキル・特性の設定管理

### 10.4 SP管理・計算システム
- 6人パーティー全員のSP値管理
- 初期SP設定（装備・パッシブ効果込み）
- ターン経過によるSP自動回復計算
- アクティブスキルによるSP回復計算
- オーバードライブによるSP回復計算
- SP変動の詳細記録・表示

### 10.5 バフ・デバフ管理システム
- プレイヤーパーティーのバフ状態管理
- 敵のデバフ状態管理
- バフ・デバフの表示機能
- 効果継続ターン数管理

### 10.6 記録表示・出力システム
- ターン別行動記録の表形式表示
- SP変動履歴の詳細表示
- 配置変更履歴の表示
- バフ・デバフ履歴の表示
- Google Spreadsheet形式でのCSV出力

## 11. 内部データ管理設計

### 11.1 設計方針
- **参考**: cshogi.pyxのBoardクラス（将棋の盤面状態管理）
- **目的**: 内部状態管理と将来の最適行動予測への流用
- **技術**: Pythonクラスとメソッドで実装

### 11.2 主要クラス構成
- **Battleクラス**: 戦闘全体の状態管理
- **Playerクラス**: 個別キャラクター状態管理
- **TurnInfoクラス**: ターン情報管理
- **AdditionalTurnStateクラス**: 追加ターン状態管理
- **SPManagerクラス**: SP計算・管理専用クラス

### 11.3 データ構造
- **ターン履歴**: 各ターンの行動記録
- **配置変更履歴**: ポジション交代の記録
- **SP変動履歴**: SP増減の詳細記録
- **バフ・デバフ構造**: 効果・継続時間・重複管理

*詳細な実装コードは関連ファイルを参照*

## 12. 開発・分析環境

### 12.1 プログラミング言語
- **メイン開発言語**: Python
- **理由**: ユーザーが理解可能な言語のため

### 12.2 想定ライブラリ
- **pandas**: CSV読み書き、データフレーム操作
- **numpy**: 数値計算
- **dataclasses**: クラス設計の簡素化
- **typing**: 型ヒント
- **enum**: 列挙型定義

### 12.3 ファイル管理方針
- **MDファイル**: 年月日時分秒.md形式（JST-9）
- **履歴保持**: 上書きではなく新規ファイル作成
- **段階的検討**: 各段階の情報を別ファイルに記録
- **コード分離**: 実装コードは別ファイル（-code_sample.py等）に分離

## 13. 今後の調査・検討項目

### 13.1 短期調査項目（v1.0対応）
- SP回復効果を持つ具体的なパッシブスキル・特性一覧
- SP回復効果を持つ具体的なアクティブスキル一覧
- 配置依存のSP回復効果の詳細条件

### 13.2 中期調査項目（v1.5対応）
- オーバードライブゲージの詳細な増減ルール
- より詳細なバフ・デバフ管理システム
- 敵行動パターンの記録方法

### 13.3 長期調査項目（v2.0以降）
- 実際のダメージ計算システムとの連携
- UI/UX改善（グラフィカルインターフェース）
- 自動戦闘シミュレーション機能

---


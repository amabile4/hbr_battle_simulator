<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ヘブンバーンズレッド戦闘シミュレータ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        /* パーティー編成セクション */
        .party-setup {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .party-setup.collapsed {
            padding: 15px 25px;
        }
        
        .party-setup.collapsed .character-config {
            display: none;
        }
        
        .party-setup.collapsed .controls {
            display: none;
        }
        
        .party-setup h2 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: color 0.3s ease;
        }
        
        .party-setup h2:hover {
            color: #667eea;
        }
        
        .party-setup.collapsed h2 {
            margin-bottom: 5px;
        }
        
        .collapse-icon {
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }
        
        .party-setup.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }
        
        .party-status {
            display: none;
            color: #38a169;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .party-setup.collapsed .party-status {
            display: block;
        }
        
        .character-config {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .character-slot {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
        }
        
        .character-slot h3 {
            color: #2d3748;
            margin-bottom: 10px;
        }
        
        .input-group {
            margin-bottom: 10px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #4a5568;
        }
        
        .input-group select,
        .input-group input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .input-group select:focus,
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* パーティー表示 */
        .party-display {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .party-formation {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .character-card {
            position: relative;
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #4299e1, #3182ce);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            text-align: center;
            line-height: 1.2;
        }
        
        .character-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .character-card.front {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }
        
        .character-card.back {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
        }
        
        .character-card.selected {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }
        
        .character-card.swap-mode {
            cursor: pointer;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }
        
        .sp-display {
            position: absolute;
            bottom: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .position-labels {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 20px;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .position-label {
            font-weight: bold;
            color: #4a5568;
        }
        
        .position-label.front {
            color: #38a169;
        }
        
        .position-label.back {
            color: #dd6b20;
        }
        
        /* コントロールパネル */
        .control-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            color: white;
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(237, 137, 54, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* スキル選択 */
        .skill-selection {
            margin-top: 20px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
        }
        
        .skill-selection h3 {
            margin-bottom: 15px;
            color: #2d3748;
        }
        
        .skill-dropdown {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e0;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .skill-dropdown option:disabled {
            color: #a0aec0;
            background-color: #f7fafc;
        }
        
        /* 結果テーブル */
        .results-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        
        .results-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: bold;
        }
        
        .results-table tr:nth-child(even) {
            background: #f7fafc;
        }
        
        .results-table tr:hover {
            background: #edf2f7;
        }
        
        /* ターン情報 */
        .turn-info {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
        }
        
        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .character-config {
                grid-template-columns: 1fr;
            }
            
            .party-formation {
                grid-template-columns: repeat(3, 1fr);
                gap: 15px;
            }
            
            .character-card {
                width: 100px;
                height: 100px;
                font-size: 11px;
            }
            
            .skill-display {
                width: 100px;
                font-size: 10px;
                min-height: 20px;
                padding: 2px 4px;
            }
            
            .sp-display {
                width: 24px;
                height: 16px;
                font-size: 10px;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔥 ヘブンバーンズレッド 戦闘シミュレータ</h1>
            <p>戦術的な戦闘をシミュレートして最適な戦略を見つけよう</p>
        </div>
        
        <!-- パーティー編成セクション -->
        <div class="party-setup" id="partySetup">
            <h2 onclick="togglePartySetup()">
                📝 パーティー編成
                <span class="collapse-icon">🔽</span>
            </h2>
            <div class="party-status" id="partyStatus">
                ✅ パーティー編成完了 - クリックして再編集
            </div>
            <div class="character-config" id="characterConfig">
                <div class="character-slot">
                    <h3>キャラクター 1</h3>
                    <div class="input-group">
                        <label>キャラクター選択</label>
                        <select id="char_0" onchange="updateCharacterSelection()">
                            <option value="">選択してください</option>
                            <option value="茅森月歌">茅森月歌</option>
                            <option value="和泉ユキ">和泉ユキ</option>
                            <option value="逢川めぐみ">逢川めぐみ</option>
                            <option value="東城つかさ">東城つかさ</option>
                            <option value="朝倉可憐">朝倉可憐</option>
                            <option value="國見タマ">國見タマ</option>
                            <option value="蒼井えりか">蒼井えりか</option>
                            <option value="水瀬いちご">水瀬いちご</option>
                            <option value="水瀬すもも">水瀬すもも</option>
                            <option value="樋口聖華">樋口聖華</option>
                            <option value="柊木梢">柊木梢</option>
                            <option value="ビャッコ">ビャッコ</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>初期SP (基本4 + 装備 + パッシブ)</label>
                        <input type="number" id="sp_0" min="4" max="20" value="6" onchange="updateCharacterSelection()">
                    </div>
                    <div class="input-group">
                        <label>ターン経過SP追加ボーナス (基本+2に上乗せ)</label>
                        <input type="number" id="bonus_0" min="0" max="3" value="0" onchange="updateCharacterSelection()">
                    </div>
                </div>
                
                <div class="character-slot">
                    <h3>キャラクター 2</h3>
                    <div class="input-group">
                        <label>キャラクター選択</label>
                        <select id="char_1" onchange="updateCharacterSelection()">
                            <option value="">選択してください</option>
                            <option value="茅森月歌">茅森月歌</option>
                            <option value="和泉ユキ">和泉ユキ</option>
                            <option value="逢川めぐみ">逢川めぐみ</option>
                            <option value="東城つかさ">東城つかさ</option>
                            <option value="朝倉可憐">朝倉可憐</option>
                            <option value="國見タマ">國見タマ</option>
                            <option value="蒼井えりか">蒼井えりか</option>
                            <option value="水瀬いちご">水瀬いちご</option>
                            <option value="水瀬すもも">水瀬すもも</option>
                            <option value="樋口聖華">樋口聖華</option>
                            <option value="柊木梢">柊木梢</option>
                            <option value="ビャッコ">ビャッコ</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>初期SP (基本4 + 装備 + パッシブ)</label>
                        <input type="number" id="sp_1" min="4" max="20" value="6" onchange="updateCharacterSelection()">
                    </div>
                    <div class="input-group">
                        <label>ターン経過SP追加ボーナス (基本+2に上乗せ)</label>
                        <input type="number" id="bonus_1" min="0" max="3" value="0" onchange="updateCharacterSelection()">
                    </div>
                </div>
                
                <div class="character-slot">
                    <h3>キャラクター 3</h3>
                    <div class="input-group">
                        <label>キャラクター選択</label>
                        <select id="char_2" onchange="updateCharacterSelection()">
                            <option value="">選択してください</option>
                            <option value="茅森月歌">茅森月歌</option>
                            <option value="和泉ユキ">和泉ユキ</option>
                            <option value="逢川めぐみ">逢川めぐみ</option>
                            <option value="東城つかさ">東城つかさ</option>
                            <option value="朝倉可憐">朝倉可憐</option>
                            <option value="國見タマ">國見タマ</option>
                            <option value="蒼井えりか">蒼井えりか</option>
                            <option value="水瀬いちご">水瀬いちご</option>
                            <option value="水瀬すもも">水瀬すもも</option>
                            <option value="樋口聖華">樋口聖華</option>
                            <option value="柊木梢">柊木梢</option>
                            <option value="ビャッコ">ビャッコ</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>初期SP (基本4 + 装備 + パッシブ)</label>
                        <input type="number" id="sp_2" min="4" max="20" value="6" onchange="updateCharacterSelection()">
                    </div>
                    <div class="input-group">
                        <label>ターン経過SP追加ボーナス (基本+2に上乗せ)</label>
                        <input type="number" id="bonus_2" min="0" max="3" value="0" onchange="updateCharacterSelection()">
                    </div>
                </div>
                
                <div class="character-slot">
                    <h3>キャラクター 4</h3>
                    <div class="input-group">
                        <label>キャラクター選択</label>
                        <select id="char_3" onchange="updateCharacterSelection()">
                            <option value="">選択してください</option>
                            <option value="茅森月歌">茅森月歌</option>
                            <option value="和泉ユキ">和泉ユキ</option>
                            <option value="逢川めぐみ">逢川めぐみ</option>
                            <option value="東城つかさ">東城つかさ</option>
                            <option value="朝倉可憐">朝倉可憐</option>
                            <option value="國見タマ">國見タマ</option>
                            <option value="蒼井えりか">蒼井えりか</option>
                            <option value="水瀬いちご">水瀬いちご</option>
                            <option value="水瀬すもも">水瀬すもも</option>
                            <option value="樋口聖華">樋口聖華</option>
                            <option value="柊木梢">柊木梢</option>
                            <option value="ビャッコ">ビャッコ</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>初期SP (基本4 + 装備 + パッシブ)</label>
                        <input type="number" id="sp_3" min="4" max="20" value="6" onchange="updateCharacterSelection()">
                    </div>
                    <div class="input-group">
                        <label>ターン経過SP追加ボーナス (基本+2に上乗せ)</label>
                        <input type="number" id="bonus_3" min="0" max="3" value="0" onchange="updateCharacterSelection()">
                    </div>
                </div>
                
                <div class="character-slot">
                    <h3>キャラクター 5</h3>
                    <div class="input-group">
                        <label>キャラクター選択</label>
                        <select id="char_4" onchange="updateCharacterSelection()">
                            <option value="">選択してください</option>
                            <option value="茅森月歌">茅森月歌</option>
                            <option value="和泉ユキ">和泉ユキ</option>
                            <option value="逢川めぐみ">逢川めぐみ</option>
                            <option value="東城つかさ">東城つかさ</option>
                            <option value="朝倉可憐">朝倉可憐</option>
                            <option value="國見タマ">國見タマ</option>
                            <option value="蒼井えりか">蒼井えりか</option>
                            <option value="水瀬いちご">水瀬いちご</option>
                            <option value="水瀬すもも">水瀬すもも</option>
                            <option value="樋口聖華">樋口聖華</option>
                            <option value="柊木梢">柊木梢</option>
                            <option value="ビャッコ">ビャッコ</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>初期SP (基本4 + 装備 + パッシブ)</label>
                        <input type="number" id="sp_4" min="4" max="20" value="6" onchange="updateCharacterSelection()">
                    </div>
                    <div class="input-group">
                        <label>ターン経過SP追加ボーナス (基本+2に上乗せ)</label>
                        <input type="number" id="bonus_4" min="0" max="3" value="0" onchange="updateCharacterSelection()">
                    </div>
                </div>
                
                <div class="character-slot">
                    <h3>キャラクター 6</h3>
                    <div class="input-group">
                        <label>キャラクター選択</label>
                        <select id="char_5" onchange="updateCharacterSelection()">
                            <option value="">選択してください</option>
                            <option value="茅森月歌">茅森月歌</option>
                            <option value="和泉ユキ">和泉ユキ</option>
                            <option value="逢川めぐみ">逢川めぐみ</option>
                            <option value="東城つかさ">東城つかさ</option>
                            <option value="朝倉可憐">朝倉可憐</option>
                            <option value="國見タマ">國見タマ</option>
                            <option value="蒼井えりか">蒼井えりか</option>
                            <option value="水瀬いちご">水瀬いちご</option>
                            <option value="水瀬すもも">水瀬すもも</option>
                            <option value="樋口聖華">樋口聖華</option>
                            <option value="柊木梢">柊木梢</option>
                            <option value="ビャッコ">ビャッコ</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>初期SP (基本4 + 装備 + パッシブ)</label>
                        <input type="number" id="sp_5" min="4" max="20" value="6" onchange="updateCharacterSelection()">
                    </div>
                    <div class="input-group">
                        <label>ターン経過SP追加ボーナス (基本+2に上乗せ)</label>
                        <input type="number" id="bonus_5" min="0" max="3" value="0" onchange="updateCharacterSelection()">
                    </div>
                </div>
            </div>
            <div class="controls">
                <button class="btn btn-primary" onclick="loadPartySetup()">編成確定</button>
                <button class="btn btn-warning" onclick="resetParty()">リセット</button>
            </div>
        </div>
        
        <!-- パーティー表示セクション -->
        <div class="party-display">
            <h2>⚔️ 戦闘フォーメーション</h2>
            <div class="turn-info" id="turnInfo">
                ターン 1 - 戦闘準備中
            </div>
            <div class="position-labels">
                <div class="position-label front">前衛 1</div>
                <div class="position-label front">前衛 2</div>
                <div class="position-label front">前衛 3</div>
                <div class="position-label back">後衛 4</div>
                <div class="position-label back">後衛 5</div>
                <div class="position-label back">後衛 6</div>
            </div>
            <div class="party-formation" id="partyFormation">
                <div class="character-card front" id="char_card_0" onclick="handleCharacterClick(0)">
                    <span>未設定</span>
                    <div class="sp-display">0</div>
                </div>
                <div class="character-card front" id="char_card_1" onclick="handleCharacterClick(1)">
                    <span>未設定</span>
                    <div class="sp-display">0</div>
                </div>
                <div class="character-card front" id="char_card_2" onclick="handleCharacterClick(2)">
                    <span>未設定</span>
                    <div class="sp-display">0</div>
                </div>
                <div class="character-card back" id="char_card_3" onclick="handleCharacterClick(3)">
                    <span>未設定</span>
                    <div class="sp-display">0</div>
                </div>
                <div class="character-card back" id="char_card_4" onclick="handleCharacterClick(4)">
                    <span>未設定</span>
                    <div class="sp-display">0</div>
                </div>
                <div class="character-card back" id="char_card_5" onclick="handleCharacterClick(5)">
                    <span>未設定</span>
                    <div class="sp-display">0</div>
                </div>
            </div>
        </div>
        
        <!-- コントロールパネル -->
        <div class="control-panel">
            <h2>🎮 戦闘コントロール</h2>
            <div class="controls">
                <button class="btn btn-warning" id="swapBtn" onclick="toggleSwapMode()">配置入れ替え</button>
                <button class="btn btn-success" id="executeBtn" onclick="executeTurn()" disabled>ターン実行</button>
                <button class="btn btn-primary" onclick="nextTurn()">次のターン</button>
            </div>
            
            <!-- スキル選択エリア -->
            <div class="skill-selection" id="skillSelection" style="display: none;">
                <h3 id="skillSelectionTitle">スキル選択</h3>
                <select class="skill-dropdown" id="skillDropdown" onchange="selectSkill()">
                    <option value="">スキルを選択してください</option>
                </select>
            </div>
        </div>
        
        <!-- 結果表示セクション -->
        <div class="results-section">
            <h2>📊 戦闘結果</h2>
            <div id="resultsContainer">
                <table class="results-table" id="resultsTable">
                    <thead>
                        <tr>
                            <th>ターン</th>
                            <th>敵行動など</th>
                            <th colspan="3">キャラクター1</th>
                            <th colspan="3">キャラクター2</th>
                            <th colspan="3">キャラクター3</th>
                            <th colspan="3">キャラクター4</th>
                            <th colspan="3">キャラクター5</th>
                            <th colspan="3">キャラクター6</th>
                        </tr>
                        <tr>
                            <th></th>
                            <th></th>
                            <th>始</th><th>行動</th><th>終</th>
                            <th>始</th><th>行動</th><th>終</th>
                            <th>始</th><th>行動</th><th>終</th>
                            <th>始</th><th>行動</th><th>終</th>
                            <th>始</th><th>行動</th><th>終</th>
                            <th>始</th><th>行動</th><th>終</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                        <!-- 結果行がJavaScriptで生成される -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let characterDatabase = {};
        let currentParty = [];
        let currentTurn = 1;
        let isSwapMode = false;
        let swapFirstSelected = null;
        let selectedCharacterForSkill = null;
        let turnActions = {};
        let battleHistory = [];
        let positionMap = [0, 1, 2, 3, 4, 5]; // ポジションインデックスマップ
        
        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('GUI初期化開始');
            // まずJSONファイルの読み込みを試行
            loadSkillData();
        });
        
        // skill.jsonデータの読み込み
        async function loadSkillData() {
            try {
                // skillDatabase.jsonファイルを読み込み
                const response = await fetch('skillDatabase.json');
                const jsonData = await response.json();
                
                characterDatabase = jsonData.characters;
                
                if (Object.keys(characterDatabase).length === 0) {
                    throw new Error('JSONデータの解析に失敗しました');
                }
                
                console.log('スキルデータ読み込み完了:', Object.keys(characterDatabase).length, 'キャラクター');
                console.log('利用可能キャラクター:', Object.keys(characterDatabase));
                
                // HTMLの初期キャラクター選択肢を更新
                updateCharacterOptions();
                
            } catch (error) {
                console.warn('skillDatabase.jsonの読み込みに失敗しました。模擬データを使用します:', error);
                loadMockData();
            }
        }
        
        // キャラクター選択肢の更新
        function updateCharacterOptions() {
            const characters = Object.keys(characterDatabase);
            
            for (let i = 0; i < 6; i++) {
                const select = document.getElementById(`char_${i}`);
                if (select) {
                    // 既存の選択値を保持
                    const currentValue = select.value;
                    
                    // オプションを更新
                    select.innerHTML = '<option value="">選択してください</option>';
                    characters.forEach(char => {
                        const option = document.createElement('option');
                        option.value = char;
                        option.textContent = char;
                        if (char === currentValue) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                }
            }
            
            // 重複チェックを実行
            updateCharacterSelection();
        }
        
        // 模擬データの読み込み（skillDatabase.jsonが利用できない場合）
        function loadMockData() {
            characterDatabase = {
                "茅森月歌": [
                    {name: "通常攻撃", cost: 0, type: "damage"},
                    {name: "ご注文をどうぞ♪", cost: 4, type: "damage"},
                    {name: "青春色のメロディ", cost: 6, type: "damage"},
                    {name: "癒しの歌声", cost: 3, type: "non_damage"}
                ],
                "和泉ユキ": [
                    {name: "通常攻撃", cost: 0, type: "damage"},
                    {name: "ブレイクカノン", cost: 7, type: "damage"},
                    {name: "精密射撃", cost: 5, type: "damage"},
                    {name: "応援", cost: 2, type: "non_damage"}
                ],
                "逢川めぐみ": [
                    {name: "通常攻撃", cost: 0, type: "damage"},
                    {name: "スタンブレード", cost: 5, type: "damage"},
                    {name: "パワーチャージ", cost: 3, type: "non_damage"}
                ],
                "東城つかさ": [
                    {name: "通常攻撃", cost: 0, type: "damage"},
                    {name: "専用スキル", cost: 4, type: "damage"},
                    {name: "回復", cost: 3, type: "non_damage"}
                ],
                "朝倉可憐": [
                    {name: "通常攻撃", cost: 0, type: "damage"},
                    {name: "一閃", cost: 6, type: "damage"},
                    {name: "連続斬", cost: 4, type: "damage"}
                ],
                "國見タマ": [
                    {name: "通常攻撃", cost: 0, type: "damage"},
                    {name: "OTR", cost: 8, type: "damage"},
                    {name: "守護", cost: 2, type: "non_damage"}
                ],
                "蒼井えりか": [
                    {name: "通常攻撃", cost: 0, type: "damage"},
                    {name: "青春スマッシュ", cost: 5, type: "damage"},
                    {name: "元気注入", cost: 3, type: "non_damage"}
                ],
                "水瀬いちご": [
                    {name: "通常攻撃", cost: 0, type: "damage"},
                    {name: "アイススラッシュ", cost: 4, type: "damage"},
                    {name: "冷却", cost: 2, type: "non_damage"}
                ],
                "水瀬すもも": [
                    {name: "通常攻撃", cost: 0, type: "damage"},
                    {name: "ファイアブラスト", cost: 6, type: "damage"},
                    {name: "炎の応援", cost: 3, type: "non_damage"}
                ],
                "樋口聖華": [
                    {name: "通常攻撃", cost: 0, type: "damage"},
                    {name: "トリック・カノン", cost: 13, type: "damage"},
                    {name: "狙撃", cost: 4, type: "damage"}
                ],
                "柊木梢": [
                    {name: "通常攻撃", cost: 0, type: "damage"},
                    {name: "クレール", cost: 8, type: "damage"},
                    {name: "守護の祈り", cost: 2, type: "non_damage"}
                ],
                "ビャッコ": [
                    {name: "通常攻撃", cost: 0, type: "damage"},
                    {name: "獣王撃", cost: 7, type: "damage"},
                    {name: "咆哮", cost: 3, type: "non_damage"}
                ]
            };
            
            console.log('模擬データ読み込み完了:', Object.keys(characterDatabase).length, 'キャラクター');
            console.log('模擬データサンプル:', characterDatabase["茅森月歌"]);
            updateCharacterOptions();
        }
        
        // キャラクター設定UIの生成
        function generateCharacterConfig() {
            const container = document.getElementById('characterConfig');
            container.innerHTML = ''; // 既存の内容をクリア
            
            const characters = Object.keys(characterDatabase);
            console.log('利用可能なキャラクター:', characters);
            
            if (characters.length === 0) {
                container.innerHTML = '<div class="loading">キャラクターデータを読み込み中...</div>';
                return;
            }
            
            for (let i = 0; i < 6; i++) {
                const slot = document.createElement('div');
                slot.className = 'character-slot';
                slot.innerHTML = `
                    <h3>キャラクター ${i + 1}</h3>
                    <div class="input-group">
                        <label>キャラクター選択</label>
                        <select id="char_${i}" onchange="updateCharacterSelection()">
                            <option value="">選択してください</option>
                            ${characters.map(char => `<option value="${char}">${char}</option>`).join('')}
                        </select>
                    </div>
                    <div class="input-group">
                        <label>初期SP (基本4 + 装備 + パッシブ)</label>
                        <input type="number" id="sp_${i}" min="4" max="20" value="6" onchange="updateCharacterSelection()">
                    </div>
                    <div class="input-group">
                        <label>ターン経過SP追加ボーナス (基本+2に上乗せ)</label>
                        <input type="number" id="bonus_${i}" min="0" max="3" value="0" onchange="updateCharacterSelection()">
                    </div>
                `;
                container.appendChild(slot);
            }
            
            console.log('キャラクター設定UI生成完了');
        }
        
        // キャラクター選択の更新（重複チェック）
        function updateCharacterSelection() {
            const selectedChars = [];
            for (let i = 0; i < 6; i++) {
                const select = document.getElementById(`char_${i}`);
                if (select && select.value) {
                    selectedChars.push(select.value);
                }
            }
            
            // 重複チェック
            for (let i = 0; i < 6; i++) {
                const select = document.getElementById(`char_${i}`);
                if (!select) continue;
                
                const options = select.querySelectorAll('option');
                
                options.forEach(option => {
                    if (option.value && option.value !== select.value) {
                        const duplicateCount = selectedChars.filter(c => c === option.value).length;
                        option.disabled = duplicateCount > 0;
                    } else {
                        option.disabled = false;
                    }
                });
            }
            
            // デバッグ用
            console.log('選択中のキャラクター:', selectedChars);
        }
        
        // パーティー編成セクションの折りたたみ切り替え
        function togglePartySetup() {
            const partySetup = document.getElementById('partySetup');
            partySetup.classList.toggle('collapsed');
            
            console.log('パーティー編成セクション切り替え');
        }
        
        // パーティー設定のロード
        function loadPartySetup() {
            currentParty = [];
            let hasIncompleteSelection = false;
            
            for (let i = 0; i < 6; i++) {
                const charSelect = document.getElementById(`char_${i}`);
                const spInput = document.getElementById(`sp_${i}`);
                const bonusInput = document.getElementById(`bonus_${i}`);
                
                const charName = charSelect ? charSelect.value : '';
                const initialSP = spInput ? (parseInt(spInput.value) || 6) : 6;
                const spBonus = bonusInput ? (parseInt(bonusInput.value) || 0) : 0;
                
                if (!charName) {
                    alert(`キャラクター ${i + 1} を選択してください`);
                    hasIncompleteSelection = true;
                    break;
                }
                
                if (!characterDatabase[charName]) {
                    alert(`キャラクター "${charName}" のデータが見つかりません`);
                    hasIncompleteSelection = true;
                    break;
                }
                
                currentParty.push({
                    name: charName,
                    initialSP: initialSP,
                    currentSP: initialSP,
                    spBonus: spBonus,
                    position: i,
                    skills: characterDatabase[charName] || []
                });
            }
            
            if (hasIncompleteSelection) {
                return;
            }
            
            // 成功時の処理
            console.log('パーティー編成完了:', currentParty);
            console.log('各キャラクターのスキル確認:');
            currentParty.forEach((player, index) => {
                console.log(`${index + 1}. ${player.name}:`, {
                    skillCount: player.skills.length,
                    skills: player.skills.map(s => `${s.name}(${s.cost}SP)`),
                    currentSP: player.currentSP
                });
            });
            
            generatePartyDisplay();
            updateResultsTableHeaders();
            
            // パーティー編成セクションを自動的に折りたたむ
            const partySetup = document.getElementById('partySetup');
            partySetup.classList.add('collapsed');
            
            // パーティー状況を更新
            const partyStatus = document.getElementById('partyStatus');
            const selectedNames = currentParty.map(p => p.name).join(', ');
            partyStatus.textContent = `✅ 編成完了: ${selectedNames}`;
            
            // 成功メッセージ
            alert('パーティー編成が完了しました！セクションが折りたたまれました。');
        }
        
        // パーティー表示の生成
        function generatePartyDisplay() {
            const container = document.getElementById('partyFormation');
            container.innerHTML = '';
            
            if (currentParty.length === 0) {
                container.innerHTML = '<div class="loading">パーティーが設定されていません。上部で編成を確定してください。</div>';
                return;
            }
            
            for (let i = 0; i < 6; i++) {
                const playerIndex = positionMap[i];
                const character = currentParty[playerIndex];
                
                // キャラクターコンテナ
                const characterContainer = document.createElement('div');
                characterContainer.className = 'character-container';
                
                // キャラクターカード
                const card = document.createElement('div');
                card.className = `character-card ${i < 3 ? 'front' : 'back'}`;
                card.id = `char_card_${i}`;
                card.onclick = () => handleCharacterClick(i);
                card.textContent = character ? character.name : '未設定';
                
                // SP表示
                const spDisplay = document.createElement('div');
                spDisplay.className = 'sp-display';
                spDisplay.textContent = character ? character.currentSP : '0';
                card.appendChild(spDisplay);
                
                // スキル表示（カードの下に独立配置）
                const skillDisplay = document.createElement('div');
                skillDisplay.className = 'skill-display inactive';
                skillDisplay.id = `skill_display_${i}`;
                
                if (character && i < 3) {
                    // 前衛のデフォルトスキル選択（通常攻撃 cost0）
                    if (!turnActions[i]) {
                        const defaultSkill = character.skills.find(skill => skill.cost === 0);
                        if (defaultSkill) {
                            turnActions[i] = {
                                character: character.name,
                                skill: defaultSkill,
                                position: i
                            };
                            console.log(`初期デフォルトスキル設定: ${character.name} → ${defaultSkill.name}`);
                        } else {
                            console.warn(`${character.name} に通常攻撃(cost0)が見つかりません`);
                        }
                    }
                    updateSkillDisplayElement(skillDisplay, i);
                } else if (i >= 3) {
                    // 後衛の場合
                    skillDisplay.textContent = '後衛待機';
                    skillDisplay.className = 'skill-display inactive';
                } else {
                    // 未設定の場合
                    skillDisplay.textContent = '未設定';
                    skillDisplay.className = 'skill-display inactive';
                }
                
                characterContainer.appendChild(card);
                characterContainer.appendChild(skillDisplay);
                container.appendChild(characterContainer);
            }
            
            updateExecuteButton();
            console.log('パーティー表示更新完了');
        }
        
        // スキル表示要素の更新
        function updateSkillDisplayElement(skillElement, position) {
            if (turnActions[position]) {
                const action = turnActions[position];
                const skillName = action.skill.name;
                const skillCost = action.skill.cost;
                
                // スキル名が長い場合は短縮
                let displayName = skillName;
                if (skillName.length > 10) {
                    displayName = skillName.substring(0, 8) + '...';
                }
                
                skillElement.textContent = `${displayName} (${skillCost})`;
                skillElement.className = skillCost === 0 ? 'skill-display default' : 'skill-display special';
            } else {
                skillElement.textContent = 'スキル未選択';
                skillElement.className = 'skill-display inactive';
            }
        }
        
        // スキル表示の更新（既存のIDベース関数）
        function updateSkillDisplay(position) {
            const skillDisplay = document.getElementById(`skill_display_${position}`);
            if (skillDisplay) {
                updateSkillDisplayElement(skillDisplay, position);
            }
        }
        
        // リセット機能
        function resetParty() {
            if (confirm('パーティー設定をリセットしますか？')) {
                currentParty = [];
                currentTurn = 1;
                battleHistory = [];
                turnActions = {};
                positionMap = [0, 1, 2, 3, 4, 5];
                
                // UI要素のリセット
                for (let i = 0; i < 6; i++) {
                    const charSelect = document.getElementById(`char_${i}`);
                    const spInput = document.getElementById(`sp_${i}`);
                    const bonusInput = document.getElementById(`bonus_${i}`);
                    
                    if (charSelect) charSelect.value = '';
                    if (spInput) spInput.value = '6';
                    if (bonusInput) bonusInput.value = '0';
                }
                
                updateCharacterSelection();
                generatePartyDisplay();
                document.getElementById('turnInfo').textContent = 'ターン 1 - 戦闘準備中';
                document.getElementById('resultsBody').innerHTML = '';
                
                console.log('パーティーリセット完了');
            }
        }
        
        // キャラクターカードクリック処理
        function handleCharacterClick(position) {
            if (isSwapMode) {
                handleSwapClick(position);
            } else {
                handleSkillSelection(position);
            }
        }
        
        // 配置入れ替えモードの切り替え
        function toggleSwapMode() {
            isSwapMode = !isSwapMode;
            const btn = document.getElementById('swapBtn');
            
            if (isSwapMode) {
                btn.textContent = '入れ替え中止';
                btn.className = 'btn btn-warning';
                document.querySelectorAll('.character-card').forEach(card => {
                    card.classList.add('swap-mode');
                });
            } else {
                btn.textContent = '配置入れ替え';
                btn.className = 'btn btn-warning';
                swapFirstSelected = null;
                document.querySelectorAll('.character-card').forEach(card => {
                    card.classList.remove('swap-mode', 'selected');
                });
            }
        }
        
        // 配置入れ替え処理
        function handleSwapClick(position) {
            if (swapFirstSelected === null) {
                swapFirstSelected = position;
                document.getElementById(`char_card_${position}`).classList.add('selected');
            } else {
                if (swapFirstSelected !== position) {
                    // 位置を交換
                    [positionMap[swapFirstSelected], positionMap[position]] = 
                    [positionMap[position], positionMap[swapFirstSelected]];
                    
                    // パーティー表示を更新
                    generatePartyDisplay();
                }
                
                // 入れ替えモード終了
                toggleSwapMode();
            }
        }
        
        // キャラクタークリック処理
        function handleCharacterClick(position) {
            if (isSwapMode) {
                handleSwap(position);
            } else {
                handleSkillSelection(position);
            }
        }
        
        // スキル選択処理
        function handleSkillSelection(position) {
            const playerIndex = positionMap[position];
            const character = currentParty[playerIndex];
            
            console.log('スキル選択開始:', {
                position,
                playerIndex,
                character: character ? character.name : 'なし',
                skills: character ? character.skills : 'なし',
                skillCount: character ? character.skills.length : 0,
                isFrontLine: position < 3
            });
            
            if (!character || position >= 3) { // 前衛のみスキル選択可能
                console.log('スキル選択不可:', position >= 3 ? '後衛' : '未設定');
                return;
            }
            
            selectedCharacterForSkill = position;
            
            const skillSelection = document.getElementById('skillSelection');
            const skillTitle = document.getElementById('skillSelectionTitle');
            const skillDropdown = document.getElementById('skillDropdown');
            
            skillTitle.textContent = `${character.name} のスキル選択`;
            skillDropdown.innerHTML = '<option value="">スキルを選択してください</option>';
            
            console.log('スキルリスト:', character.skills);
            
            character.skills.forEach((skill, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${skill.name} (SP:${skill.cost})`;
                option.disabled = skill.cost > character.currentSP;
                skillDropdown.appendChild(option);
                
                console.log(`スキル追加: ${skill.name} (SP:${skill.cost}) ${option.disabled ? '[使用不可]' : '[使用可]'}`);
            });
            
            // 現在選択されているスキルをハイライト
            if (turnActions[position]) {
                const currentSkillIndex = character.skills.findIndex(skill => 
                    skill.name === turnActions[position].skill.name && 
                    skill.cost === turnActions[position].skill.cost
                );
                if (currentSkillIndex >= 0) {
                    skillDropdown.value = currentSkillIndex;
                }
            }
            
            skillSelection.style.display = 'block';
            
            // 選択された状態を表示
            document.querySelectorAll('.character-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById(`char_card_${position}`).classList.add('selected');
            
            console.log('スキル選択UI表示完了');
        }
        
        // スキル選択
        function selectSkill() {
            const skillDropdown = document.getElementById('skillDropdown');
            const skillIndex = skillDropdown.value;
            
            console.log('スキル選択実行:', {
                selectedCharacterForSkill,
                skillIndex,
                dropdownValue: skillDropdown.value
            });
            
            if (skillIndex !== '' && selectedCharacterForSkill !== null) {
                const playerIndex = positionMap[selectedCharacterForSkill];
                const character = currentParty[playerIndex];
                const skill = character.skills[skillIndex];
                
                console.log('スキル選択詳細:', {
                    character: character.name,
                    skill: skill.name,
                    cost: skill.cost,
                    position: selectedCharacterForSkill
                });
                
                turnActions[selectedCharacterForSkill] = {
                    character: character.name,
                    skill: skill,
                    position: selectedCharacterForSkill
                };
                
                // UI更新
                const card = document.getElementById(`char_card_${selectedCharacterForSkill}`);
                card.style.border = '3px solid #4ade80';
                
                // スキル表示更新
                updateSkillDisplay(selectedCharacterForSkill);
                
                // ダイアログを閉じる
                document.getElementById('skillSelection').style.display = 'none';
                
                // 選択状態をリセット
                document.querySelectorAll('.character-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                selectedCharacterForSkill = null;
                
                updateExecuteButton();
                
                console.log(`スキル選択完了: ${character.name} → ${skill.name} (SP:${skill.cost})`);
            } else {
                console.log('スキル選択失敗: 無効な選択', {
                    skillIndex,
                    selectedCharacterForSkill
                });
            }
        }
        
        // 実行ボタンの状態更新
        function updateExecuteButton() {
            const frontPositions = [0, 1, 2];
            const executeBtn = document.getElementById('executeBtn');
            
            let allActionsReady = true;
            let debugInfo = [];
            
            frontPositions.forEach(pos => {
                const playerIndex = positionMap[pos];
                const character = currentParty[playerIndex];
                const hasAction = turnActions[pos];
                
                debugInfo.push({
                    position: pos,
                    character: character ? character.name : '未設定',
                    hasAction: !!hasAction,
                    action: hasAction ? `${hasAction.skill.name}(${hasAction.skill.cost})` : 'なし'
                });
                
                if (character && !hasAction) {
                    allActionsReady = false;
                }
            });
            
            console.log('実行ボタン状態チェック:', {
                allActionsReady,
                details: debugInfo,
                turnActionsCount: Object.keys(turnActions).length
            });
            
            if (executeBtn) {
                executeBtn.disabled = !allActionsReady;
                console.log('実行ボタン状態:', allActionsReady ? '有効' : '無効');
            }
        }
        
        // ターン実行
        function executeTurn() {
            const turnData = {
                turn: currentTurn,
                enemyAction: "敵行動",
                characters: []
            };
            
            // SP回復とターン処理
            currentParty.forEach((character, index) => {
                if (!character) return;
                
                const startSP = character.currentSP;
                
                // ターン開始時SP回復
                character.currentSP += 2 + character.spBonus;
                character.currentSP = Math.min(character.currentSP, 20);
                
                // 行動処理
                const position = positionMap.indexOf(index);
                let action = "待機";
                let endSP = character.currentSP;
                
                if (position < 3 && turnActions[position]) {
                    const skillData = turnActions[position].skill;
                    action = skillData.name;
                    endSP = character.currentSP - skillData.cost;
                    character.currentSP = endSP;
                }
                
                turnData.characters.push({
                    name: character.name,
                    startSP: character.currentSP + (turnActions[positionMap.indexOf(index)]?.skill?.cost || 0) - 2 - character.spBonus,
                    action: action,
                    endSP: character.currentSP
                });
            });
            
            battleHistory.push(turnData);
            updateResultsTable();
            generatePartyDisplay();
            
            // リセット
            turnActions = {};
            document.querySelectorAll('.character-card').forEach(card => {
                card.style.border = '';
                card.classList.remove('selected');
            });
            
            // 前衛のデフォルトスキル再設定
            for (let i = 0; i < 3; i++) {
                const playerIndex = positionMap[i];
                const character = currentParty[playerIndex];
                if (character) {
                    const defaultSkill = character.skills.find(skill => skill.cost === 0);
                    if (defaultSkill) {
                        turnActions[i] = {
                            character: character.name,
                            skill: defaultSkill,
                            position: i
                        };
                        console.log(`デフォルトスキル再設定: ${character.name} → ${defaultSkill.name}`);
                    }
                    // スキル表示を更新
                    updateSkillDisplay(i);
                }
            }
            
            updateExecuteButton();
            console.log('ターン実行後のリセット完了');
        }
        
        // 次のターン
        function nextTurn() {
            currentTurn++;
            document.getElementById('turnInfo').textContent = `ターン ${currentTurn} - 戦闘中`;
        }
        
        // 結果テーブルのヘッダー更新
        function updateResultsTableHeaders() {
            const headerRow = document.querySelector('.results-table thead tr:first-child');
            const subHeaderRow = document.querySelector('.results-table thead tr:last-child');
            
            if (!headerRow || !subHeaderRow) return;
            
            // ヘッダーを動的に更新
            headerRow.innerHTML = `
                <th>ターン</th>
                <th>敵行動など</th>
                ${currentParty.map(char => `<th colspan="3">${char.name}</th>`).join('')}
            `;
            
            subHeaderRow.innerHTML = `
                <th></th>
                <th></th>
                ${currentParty.map(() => '<th>始</th><th>行動</th><th>終</th>').join('')}
            `;
        }
        
        // 結果テーブルの更新
        function updateResultsTable() {
            const tbody = document.getElementById('resultsBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            battleHistory.forEach(turn => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${turn.turn}</td>
                    <td>${turn.enemyAction}</td>
                    ${turn.characters.map(char => 
                        `<td>${char.startSP}</td><td>${char.action}</td><td>${char.endSP}</td>`
                    ).join('')}
                `;
                tbody.appendChild(row);
            });
        }
        
        // キャラクターカードクリック処理
        function handleCharacterClick(position) {
            if (isSwapMode) {
                handleSwapClick(position);
            } else {
                handleSkillSelection(position);
            }
        }
        
        // 配置入れ替えモードの切り替え
        function toggleSwapMode() {
            isSwapMode = !isSwapMode;
            const btn = document.getElementById('swapBtn');
            
            if (isSwapMode) {
                btn.textContent = '入れ替え中止';
                btn.className = 'btn btn-warning';
                document.querySelectorAll('.character-card').forEach(card => {
                    card.classList.add('swap-mode');
                });
            } else {
                btn.textContent = '配置入れ替え';
                btn.className = 'btn btn-warning';
                swapFirstSelected = null;
                document.querySelectorAll('.character-card').forEach(card => {
                    card.classList.remove('swap-mode', 'selected');
                });
            }
        }
        
        // 配置入れ替え処理
        function handleSwapClick(position) {
            if (swapFirstSelected === null) {
                swapFirstSelected = position;
                document.getElementById(`char_card_${position}`).classList.add('selected');
            } else {
                if (swapFirstSelected !== position) {
                    // 位置を交換
                    [positionMap[swapFirstSelected], positionMap[position]] = 
                    [positionMap[position], positionMap[swapFirstSelected]];
                    
                    // パーティー表示を更新
                    generatePartyDisplay();
                }
                
                // 入れ替えモード終了
                toggleSwapMode();
            }
        }
        
        // スキル選択処理
        function handleSkillSelection(position) {
            if (isSwapMode) return;
            
            const playerIndex = positionMap[position];
            const character = currentParty[playerIndex];
            
            if (!character || position >= 3) { // 前衛のみスキル選択可能
                return;
            }
            
            selectedCharacterForSkill = position;
            
            const skillSelection = document.getElementById('skillSelection');
            const skillTitle = document.getElementById('skillSelectionTitle');
            const skillDropdown = document.getElementById('skillDropdown');
            
            skillTitle.textContent = `${character.name} のスキル選択`;
            skillDropdown.innerHTML = '<option value="">スキルを選択してください</option>';
            
            character.skills.forEach((skill, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${skill.name} (SP:${skill.cost})`;
                option.disabled = skill.cost > character.currentSP;
                skillDropdown.appendChild(option);
            });
            
            skillSelection.style.display = 'block';
            
            // 選択された状態を表示
            document.querySelectorAll('.character-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById(`char_card_${position}`).classList.add('selected');
        }
        
        // スキル選択
        function selectSkill() {
            const skillDropdown = document.getElementById('skillDropdown');
            const skillIndex = skillDropdown.value;
            
            if (skillIndex !== '' && selectedCharacterForSkill !== null) {
                const playerIndex = positionMap[selectedCharacterForSkill];
                const character = currentParty[playerIndex];
                const skill = character.skills[skillIndex];
                
                turnActions[selectedCharacterForSkill] = {
                    character: character.name,
                    skill: skill,
                    position: selectedCharacterForSkill
                };
                
                // UI更新
                const card = document.getElementById(`char_card_${selectedCharacterForSkill}`);
                card.style.border = '3px solid #4ade80';
                
                document.getElementById('skillSelection').style.display = 'none';
                selectedCharacterForSkill = null;
                
                updateExecuteButton();
            }
        }
        
        // 実行ボタンの状態更新
        function updateExecuteButton() {
            const frontPositions = [0, 1, 2];
            const actionsSet = frontPositions.every(pos => {
                const playerIndex = positionMap[pos];
                const character = currentParty[playerIndex];
                return character && (turnActions[pos] || !character);
            });
            
            document.getElementById('executeBtn').disabled = !actionsSet;
        }
        
        // ターン実行
        function executeTurn() {
            const turnData = {
                turn: currentTurn,
                enemyAction: "敵行動",
                characters: []
            };
            
            // SP回復とターン処理
            currentParty.forEach((character, index) => {
                if (!character) return;
                
                const startSP = character.currentSP;
                
                // ターン開始時SP回復
                character.currentSP += 2 + character.spBonus;
                character.currentSP = Math.min(character.currentSP, 20);
                
                // 行動処理
                const position = positionMap.indexOf(index);
                let action = "待機";
                let endSP = character.currentSP;
                
                if (position < 3 && turnActions[position]) {
                    const skillData = turnActions[position].skill;
                    action = skillData.name;
                    endSP = character.currentSP - skillData.cost;
                    character.currentSP = endSP;
                }
                
                turnData.characters.push({
                    name: character.name,
                    startSP: character.currentSP + (turnActions[positionMap.indexOf(index)]?.skill?.cost || 0) - 2 - character.spBonus,
                    action: action,
                    endSP: character.currentSP
                });
            });
            
            battleHistory.push(turnData);
            updateResultsTable();
            generatePartyDisplay();
            
            // リセット
            turnActions = {};
            document.querySelectorAll('.character-card').forEach(card => {
                card.style.border = '';
                card.classList.remove('selected');
            });
            
            updateExecuteButton();
        }
        
        // 次のターン
        function nextTurn() {
            currentTurn++;
            document.getElementById('turnInfo').textContent = `ターン ${currentTurn} - 戦闘中`;
        }
    </script>
</body>
</html>
# 開発記録・仕様書

## 2025年6月14日 - セッション記録

### 修正・追加された仕様

#### 1. UI/UX改善
- **パーティー編成完了時のポップアップ削除**: OKボタンを押す必要をなくし、視覚的フィードバックのみで完了を通知
- **デフォルトパーティー設定**: リロード時に茅森月歌、和泉ユキ、逢川めぐみ、東城つかさ、朝倉可憐、國見タマが自動選択される

#### 2. ターン実行システムの仕様確定
- **ターン実行ボタン**: プレビュー機能として動作し、実際のSP消費は行わない
- **次のターンボタン**: SP変更を確定し、ターン数をインクリメント、SP回復処理を実行
- **SP状態管理**: ターン実行前のSP状態を保存し、配置入れ替え時に復元
- **未実行ターン対応**: 次のターンボタン押下時、未実行のターンがある場合は自動的にターン実行

#### 3. 配置入れ替えシステム
- **スキル選択状態の管理**: 
  - 前衛同士の入れ替え: スキル選択状態も一緒に入れ替え
  - 前衛と後衛の入れ替え: 前衛のスキル選択をクリア、新前衛にデフォルトスキル設定
- **UI状態管理**: 配置入れ替えモード開始時にスキル選択UIを非表示
- **SP状態復元**: 配置入れ替え時にプレビュー状態のSPを元に戻す

#### 4. スキル選択の持続性
- **ターン実行後の保持**: ターン実行後もスキル選択状態を保持し、再編集可能
- **次のターンでリセット**: 次のターンボタンでのみスキル選択を初期化

### 技術的実装詳細

#### グローバル変数追加
```javascript
let savedSPState = []; // ターン実行前のSP状態を保存
let defaultPartySettings = {
    characters: ["茅森月歌", "和泉ユキ", "逢川めぐみ", "東城つかさ", "朝倉可憐", "國見タマ"],
    initialSP: 6,
    spBonus: 0
};
```

#### 主要関数の役割分担
- `executeTurn()`: プレビュー実行、SP状態保存、結果記録（同一ターンは上書き）
- `nextTurn()`: 未実行ターン自動実行、SP確定、ターンインクリメント、SP回復、スキルリセット
- `saveSPState()` / `restoreSPState()`: SP状態の保存・復元
- `handleSkillSwap()`: 配置入れ替え時のスキル選択状態管理

#### 配置入れ替え時の処理順序
1. SP状態復元（プレビュー取り消し）
2. スキル選択状態の適切な入れ替え・クリア
3. スキル選択UI非表示
4. 表示更新

### 解決した問題

1. **パーティー編成の利便性**: 毎回手動選択からデフォルト自動選択へ
2. **ターン実行の混乱**: プレビューと確定の明確な分離
3. **SP管理の不整合**: 配置入れ替え時のSP状態復元
4. **UI状態の混乱**: 配置入れ替え時のスキル選択UI適切な非表示
5. **ターンスキップ**: 未実行ターンの自動補完

### 今後の改善候補

- デフォルトパーティー設定の設定画面実装
- SP回復効果の詳細設定機能
- 戦闘履歴のエクスポート機能強化
- オーバードライブシステムの実装

### 注意事項

- `defaultPartySettings`は将来的に設定画面で変更可能にする予定（現在はハードコーディング回避済み）
- SP状態管理は`savedSPState`配列で行い、次のターン確定時にクリア
- 配置入れ替え時は必ずスキル選択UIを非表示にしてユーザー混乱を防止

## 実装済み機能の詳細分析

### 現在実装されている機能（README.mdとの対比）

#### ✅ 完全実装済み

1. **基本戦闘システム**
   - 6人パーティー（前衛3・後衛3）の完全実装
   - 前後衛交代システム（2段階選択UI）
   - ターン進行システム（プレビュー→確定の2段階）

2. **SP管理システム**
   - 初期SP設定（4-20の範囲、個別設定可能）
   - SPボーナス設定（0-3の追加回復量）
   - ターン経過による基本回復（+2）
   - SP上限管理（20でキャップ）
   - プレビュー機能による一時的SP消費表示

3. **スキル管理システム**
   - 58キャラクター、443スキルの大規模データベース
   - アクティブスキル選択（前衛のみ）
   - SP不足スキルの自動無効化
   - ダメージ/非ダメージの分類表示

4. **データ管理システム**
   - JSON形式のスキルデータベース
   - 読み込み失敗時の模擬データフォールバック
   - キャラクター重複選択防止
   - データ整合性チェック

5. **記録・表示システム**
   - ターン別戦闘履歴の詳細記録
   - 動的ヘッダー生成（キャラクター名対応）
   - SP開始値・行動・終了値の3列表示
   - 同一ターン上書き機能

#### 🔶 部分実装済み

1. **特殊ターンシステム**
   - 基本ターン管理は完全実装
   - オーバードライブ（OD1-3）: 未実装
   - 追加ターン: 未実装

2. **バフ・デバフ管理**
   - 基本的な表示枠組みは存在
   - 詳細な状態管理: 未実装
   - エンハンス重複管理: 未実装

3. **行動順序決定システム**
   - スキル分類による表示は実装済み
   - 2フェーズ実行順序: 記録のみ（実際の順序実行なし）

#### ❌ 未実装機能

1. **オーバードライブシステム**
   - OD1-3の段階別SP回復
   - オーバードライブゲージ管理
   - 上限突破SP回復

2. **追加ターンシステム**
   - 追加ターン状態管理
   - 交代制限ロジック
   - 追加ターン表記

3. **CSV出力機能**
   - Google Spreadsheet形式での出力
   - 3行ヘッダー構造
   - 特殊ターン表記（OD1、追加1等）

4. **配置依存SP回復**
   - 前衛/後衛配置による回復効果
   - 他キャラクターへの影響
   - 条件付きSP回復

### 技術的優位性の詳細

#### モジュラー設計の効果
- **コード重複排除**: 統合版の7つの重複関数を完全解決
- **ファイルサイズ**: 71KB → 26KB（63%削減）
- **保守性**: 機能別ファイル分割による可読性向上
- **並行開発**: 複数開発者での同時作業可能

#### UI/UX の改善点
1. **レスポンシブデザイン**: モバイル対応の詳細CSS
2. **アニメーション効果**: カードホバー、パルス、選択時の光る効果
3. **直感的操作**: 2段階選択、色分け表示、状態の視覚化
4. **エラー防止**: 重複選択防止、SP不足表示、状態同期

#### パフォーマンス最適化
1. **非同期データ読み込み**: JSONファイルの効率的読み込み
2. **DOM操作最適化**: 必要最小限の要素更新
3. **状態管理**: グローバル変数による高速アクセス
4. **キャッシュ効率**: モジュール分割による部分更新

### 実装の技術的詳細

#### SP状態管理の実装
```javascript
// プレビュー用SP保存
savedSPState = currentParty.map(character => 
    character ? character.currentSP : 0
);

// 配置入れ替え時の復元
currentParty.forEach((character, index) => {
    if (character && savedSPState[index] !== undefined) {
        character.currentSP = savedSPState[index];
    }
});
```

#### 配置入れ替えロジック
```javascript
// 前衛同士: スキル状態も入れ替え
// 前衛-後衛: 前衛スキルクリア、新前衛にデフォルト設定
if (isFront1 && isFront2) {
    // スキル選択状態の入れ替え
} else {
    // スキル選択のクリアとデフォルト設定
}
```

#### ターン管理の2段階システム
1. **executeTurn()**: プレビュー実行、SP保存、結果記録
2. **nextTurn()**: 未実行チェック、SP確定、ターンインクリメント

### 今後の優先実装項目

#### 高優先度
1. **CSV出力機能**: Google Spreadsheet互換形式
2. **オーバードライブ基本機能**: UI追加とSP回復
3. **設定画面**: デフォルトパーティー変更機能

#### 中優先度
1. **追加ターンシステム**: 状態管理と交代制限
2. **バフ・デバフ詳細管理**: 状態表示と継続管理
3. **行動順序実行**: 2フェーズでの実際の順序制御

#### 低優先度
1. **配置依存SP回復**: 複雑な条件管理
2. **敵行動パターン**: 記録用の拡張機能
3. **自動戦闘機能**: AI判定システム

### 設計思想と将来展望

このシミュレータは「戦術分析ツール」として設計されており、実際のゲームプレイでの戦略立案を支援することを目的としています。プレビュー機能による試行錯誤、詳細なSP管理、配置戦術の検証など、戦術RPGに必要な分析機能を網羅的に提供しています。

将来的には、AI による最適行動提案、大規模戦闘データの分析機能、他の戦術RPGへの応用展開なども視野に入れた拡張可能な設計となっています。
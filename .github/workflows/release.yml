name: ğŸš€ Release

on:
  push:
    tags:
      - 'v*'

jobs:
  test:
    name: ğŸ§ª Pre-release Tests
    uses: ./.github/workflows/test.yml

  release:
    name: ğŸ“¦ Create Release
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: write
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies
        run: npm ci
        
      - name: ğŸ§ª Run final tests
        run: npm run test:coverage
        
      - name: ğŸ“Š Generate release artifacts
        run: |
          echo "ğŸ—ï¸ Preparing release artifacts..."
          
          # ãƒªãƒªãƒ¼ã‚¹ç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™
          mkdir -p release
          
          # HTMLãƒ•ã‚¡ã‚¤ãƒ«
          cp hbr_gui_simulator_modular.html release/
          
          # JS/CSSãƒ•ã‚¡ã‚¤ãƒ«
          cp -r js css release/
          
          # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
          cp skillDatabase.json release/
          
          # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
          cp README.md CLAUDE.md DEVELOPMENT_NOTES.md release/
          
          # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆç”Ÿæˆ
          echo "# Release Notes" > release/RELEASE_NOTES.md
          echo "" >> release/RELEASE_NOTES.md
          echo "ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ github.ref_name }}" >> release/RELEASE_NOTES.md
          echo "ãƒªãƒªãƒ¼ã‚¹æ—¥: $(date '+%Y-%m-%d')" >> release/RELEASE_NOTES.md
          echo "" >> release/RELEASE_NOTES.md
          echo "## ğŸ® ãƒ˜ãƒ–ãƒ³ãƒãƒ¼ãƒ³ã‚ºãƒ¬ãƒƒãƒ‰æˆ¦é—˜ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿" >> release/RELEASE_NOTES.md
          echo "" >> release/RELEASE_NOTES.md
          echo "### ğŸ“¦ å«ã¾ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«" >> release/RELEASE_NOTES.md
          echo "- ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿æœ¬ä½“ (HTML/CSS/JS)" >> release/RELEASE_NOTES.md
          echo "- ã‚¹ã‚­ãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ (JSON)" >> release/RELEASE_NOTES.md
          echo "- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ" >> release/RELEASE_NOTES.md
          echo "" >> release/RELEASE_NOTES.md
          echo "### ğŸš€ ä½¿ç”¨æ–¹æ³•" >> release/RELEASE_NOTES.md
          echo "1. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰" >> release/RELEASE_NOTES.md
          echo "2. \`python3 -m http.server 8080\` ã§ã‚µãƒ¼ãƒãƒ¼èµ·å‹•" >> release/RELEASE_NOTES.md
          echo "3. \`http://localhost:8080/hbr_gui_simulator_modular.html\` ã«ã‚¢ã‚¯ã‚»ã‚¹" >> release/RELEASE_NOTES.md
          
          # ZIPãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
          cd release
          zip -r "../hbr-battle-simulator-${{ github.ref_name }}.zip" .
          cd ..
          
          echo "âœ… Release artifacts prepared"
          
      - name: ğŸ“ Extract release notes
        id: extract_notes
        run: |
          # æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’æŠ½å‡º
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          git log -1 --pretty=format:"%B" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      - name: ğŸš€ Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: "ãƒ˜ãƒ–ãƒ³ãƒãƒ¼ãƒ³ã‚ºãƒ¬ãƒƒãƒ‰æˆ¦é—˜ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ ${{ github.ref_name }}"
          body: |
            ## ğŸ® ãƒ˜ãƒ–ãƒ³ãƒãƒ¼ãƒ³ã‚ºãƒ¬ãƒƒãƒ‰æˆ¦é—˜ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿
            
            ${{ steps.extract_notes.outputs.notes }}
            
            ### ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ
            - âœ… å…¨ãƒ†ã‚¹ãƒˆãŒé€šé
            - âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¤œè¨¼å®Œäº†
            - âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯å®Œäº†
            
            ### ğŸš€ ä½¿ç”¨æ–¹æ³•
            1. `hbr-battle-simulator-${{ github.ref_name }}.zip` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            2. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å±•é–‹
            3. `python3 -m http.server 8080` ã§ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
            4. ãƒ–ãƒ©ã‚¦ã‚¶ã§ `http://localhost:8080/hbr_gui_simulator_modular.html` ã«ã‚¢ã‚¯ã‚»ã‚¹
            
            ### ğŸ”§ æŠ€è¡“ä»•æ§˜
            - ãƒ¢ã‚¸ãƒ¥ãƒ©ãƒ¼JavaScript ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
            - ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–Webãƒ‡ã‚¶ã‚¤ãƒ³
            - JSONãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
            - è‡ªå‹•ãƒ†ã‚¹ãƒˆå¯¾å¿œ
            
            ---
            ğŸ¤– è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸãƒªãƒªãƒ¼ã‚¹
          draft: false
          prerelease: false
          
      - name: ğŸ“ Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./hbr-battle-simulator-${{ github.ref_name }}.zip
          asset_name: hbr-battle-simulator-${{ github.ref_name }}.zip
          asset_content_type: application/zip
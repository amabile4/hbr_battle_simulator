name: ðŸ§ª Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: ðŸ” Unit Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18, 20]
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          
      - name: ðŸ”§ Install dependencies
        run: npm ci
        
      - name: ðŸ§ª Run tests
        run: npm test
        
      - name: ðŸ“Š Generate coverage report
        run: npm run test:coverage
        
      - name: ðŸ“ˆ Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  lint:
    name: ðŸ” Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ðŸ”§ Install dependencies
        run: npm ci
        
      - name: ðŸŽ¨ Check code style (future)
        run: echo "ESLint/Prettier will be added here"
        
      - name: ðŸ” Check for secrets
        run: |
          echo "Checking for potential secrets..."
          if grep -r "api.key\|password\|secret" --include="*.js" --include="*.json" --exclude-dir=node_modules --exclude-dir=.git .; then
            echo "âš ï¸ Potential secrets found!"
            exit 1
          fi
          echo "âœ… No secrets detected"

  data-validation:
    name: ðŸ“Š Data Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ðŸ”§ Install dependencies
        run: npm ci
        
      - name: ðŸ—ƒï¸ Validate skill database
        run: |
          echo "ðŸ” Validating skillDatabase.json..."
          node -e "
            const fs = require('fs');
            try {
              const data = JSON.parse(fs.readFileSync('skillDatabase.json', 'utf8'));
              console.log('âœ… JSON is valid');
              console.log('ðŸ“Š Characters:', Object.keys(data.characters).length);
              console.log('ðŸ“Š Total skills:', Object.values(data.characters).flat().length);
            } catch (error) {
              console.error('âŒ JSON validation failed:', error.message);
              process.exit(1);
            }
          "

  deployment-check:
    name: ðŸš€ Deployment Check
    runs-on: ubuntu-latest
    needs: [test, lint, data-validation]
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸŒ Test static file serving
        run: |
          echo "ðŸ” Checking static files..."
          
          # HTMLãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          if [ ! -f "hbr_gui_simulator_modular.html" ]; then
            echo "âŒ Main HTML file not found"
            exit 1
          fi
          
          # JSãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          for file in js/*.js; do
            if [ ! -f "$file" ]; then
              echo "âŒ Missing JS file: $file"
              exit 1
            fi
          done
          
          # CSSãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          for file in css/*.css; do
            if [ ! -f "$file" ]; then
              echo "âŒ Missing CSS file: $file"
              exit 1
            fi
          done
          
          echo "âœ… All static files found"
          
      - name: ðŸ Test Python server
        run: |
          echo "ðŸ” Testing Python HTTP server..."
          
          # Pythonã‚µãƒ¼ãƒãƒ¼ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§èµ·å‹•
          python3 -m http.server 8080 &
          SERVER_PID=$!
          
          # ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ã‚’å¾…ã¤
          sleep 3
          
          # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
          if curl -f http://localhost:8080/hbr_gui_simulator_modular.html > /dev/null 2>&1; then
            echo "âœ… Server responds correctly"
          else
            echo "âŒ Server health check failed"
            kill $SERVER_PID
            exit 1
          fi
          
          # ã‚µãƒ¼ãƒãƒ¼åœæ­¢
          kill $SERVER_PID
          echo "âœ… Python server test completed"

  notify:
    name: ðŸ“¢ Notification
    runs-on: ubuntu-latest
    needs: [test, lint, data-validation, deployment-check]
    if: always()
    
    steps:
      - name: ðŸ“Š Test Results Summary
        run: |
          echo "## ðŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "âœ… **Unit Tests**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Unit Tests**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.lint.result }}" == "success" ]; then
            echo "âœ… **Code Quality**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Code Quality**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.data-validation.result }}" == "success" ]; then
            echo "âœ… **Data Validation**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Data Validation**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.deployment-check.result }}" == "success" ]; then
            echo "âœ… **Deployment Check**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Deployment Check**: Failed" >> $GITHUB_STEP_SUMMARY
          fi